<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeriesFav - TV</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root { --bg-main: #0a0a0a; --accent-default: #e50914; }
* { box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: #ffffff; overflow: hidden; cursor: none; user-select: none; }

/* ── SIDEBAR ── */
#sidebar { width: 90px; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); background: rgba(10,10,10,0.97); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.05); box-shadow: 10px 0 30px rgba(0,0,0,0.5); position: fixed; left: 0; top: 0; height: 100vh; z-index: 50; display: flex; flex-direction: column; padding: 2.5rem 0; overflow: hidden; }
#sidebar.expanded { width: 280px; }
#sidebar .label, #sidebar .filter-group { opacity: 0; white-space: nowrap; pointer-events: none; transition: opacity 0.3s; }
#sidebar.expanded .label, #sidebar.expanded .filter-group { opacity: 1; pointer-events: all; }
.nav-link { display: flex; align-items: center; gap: 1.2rem; padding: 1rem 1.5rem; border-radius: 14px; margin: 0 0.6rem; cursor: pointer; transition: all 0.25s; color: #9ca3af; font-size: 1.1rem; font-weight: 500; outline: none; }
.nav-link:focus, .nav-link.active { background: rgba(255,255,255,0.08); color: #fff; outline: 3px solid var(--accent-default); outline-offset: 2px; }
.nav-link.active { color: var(--accent-default); outline: none; }
.nav-link:focus { color: #fff; }
.nav-link i { font-size: 1.4rem; width: 1.8rem; text-align: center; flex-shrink: 0; }
.sidebar-select { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 1rem; padding: 0.85rem 1rem; border-radius: 10px; width: 100%; outline: none; cursor: pointer; appearance: none; }
.sidebar-select:focus { border-color: var(--accent-default); outline: 3px solid var(--accent-default); outline-offset: 2px; }

/* ── MAIN ── */
#main-content { margin-left: 90px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
#header { flex-shrink: 0; padding: 1.5rem 3rem; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent); }
#content-area { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 3rem 3rem; scroll-behavior: smooth; }
#content-area::-webkit-scrollbar { width: 6px; }
#content-area::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

/* ── SEARCH ── */
#search-bar { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 50px; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; width: 360px; transition: all 0.3s; }
#search-bar:focus-within { background: rgba(255,255,255,0.1); border-color: var(--accent-default); outline: 3px solid var(--accent-default); outline-offset: 2px; }
#buscador { background: transparent; border: none; outline: none; color: #fff; font-size: 1rem; width: 100%; font-family: 'Inter', sans-serif; }

/* ── PROMO WIDGET ── */
.promo-widget { width: 300px; height: 100px; background: rgba(20,20,20,0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; display: flex; overflow: hidden; cursor: pointer; transition: transform 0.3s, border-color 0.3s; outline: none; }
.promo-widget:focus { border-color: var(--accent-default); outline: 3px solid var(--accent-default); outline-offset: 2px; transform: translateY(-4px); }

/* ── GRID ── */
#grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 2rem; }
.poster-card { position: relative; border-radius: 18px; overflow: hidden; aspect-ratio: 2/3; cursor: pointer; background: #1a1a1a; outline: none; transition: transform 0.25s; }
.poster-card:focus { outline: 4px solid var(--accent-default); outline-offset: 4px; transform: scale(1.06); }
.poster-card:focus .poster-overlay { opacity: 1; }
.poster-card:focus .fav-btn { opacity: 1; }
.poster-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
.poster-card:focus img { transform: scale(1.05); }
.poster-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 60%); display: flex; flex-direction: column; justify-content: flex-end; padding: 1.25rem; opacity: 0; transition: opacity 0.3s; }
.fav-btn { position: absolute; top: 0.9rem; right: 0.9rem; z-index: 20; background: rgba(0,0,0,0.55); backdrop-filter: blur(10px); width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; opacity: 0; border: none; cursor: pointer; }
.fav-btn.active i { color: var(--accent-default); }

/* ── MODAL OVERLAY ── */
#modal { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; padding: 2rem; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); }
#modal.flex { display: flex; }
#modal-close { position: fixed; top: 2rem; right: 2rem; font-size: 2rem; color: #9ca3af; background: rgba(0,0,0,0.3); width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); z-index: 110; cursor: pointer; outline: none; padding-bottom: 4px; }
#modal-close:focus { outline: 3px solid var(--accent-default); color: #fff; }

/* ── MODAL CONTENT ── */
#modal-content-wrapper { background: #111; max-width: 820px; width: 100%; border-radius: 28px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); display: grid; grid-template-columns: 2fr 3fr; box-shadow: 0 30px 80px rgba(0,0,0,0.7); }
#m-img { padding: 2rem; background: #0c0c0c; display: flex; align-items: center; justify-content: center; min-height: 380px; border-right: 1px solid rgba(255,255,255,0.05); }
#m-info-panel { padding: 2.5rem; display: flex; flex-direction: column; justify-content: center; position: relative; }
#m-title { font-size: 1.8rem; font-weight: 700; margin: 0.75rem 0 1rem; }
#m-desc { color: #9ca3af; line-height: 1.7; font-size: 0.95rem; max-height: 130px; overflow-y: auto; padding-right: 0.5rem; outline: none; }
#m-desc::-webkit-scrollbar { width: 4px; }
#m-desc::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
#m-desc:focus { color: #d1d5db; }
#m-season-chips { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.5rem; }
.season-chip { padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.8rem; font-weight: 700; border: none; cursor: pointer; outline: none; transition: all 0.2s; }
.season-chip:focus { outline: 3px solid var(--accent-default); }
.modal-action-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.65rem 1.1rem; border-radius: 10px; font-weight: 700; font-size: 0.85rem; border: none; cursor: pointer; transition: all 0.25s; outline: none; }
.modal-action-btn:focus { outline: 3px solid #fff; outline-offset: 2px; transform: scale(1.06); }

/* ── SUB-SELECTORS ── */
#watch-selector, #download-selector { background: #111; max-width: 420px; width: 100%; border-radius: 28px; padding: 2.5rem; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 80px rgba(0,0,0,0.7); flex-direction: column; gap: 1.5rem; animation: fadeIn 0.3s ease; }
.dl-select, .watch-select { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 14px; padding: 1rem 1.25rem; width: 100%; outline: none; cursor: pointer; font-size: 1rem; font-family: 'Inter', sans-serif; appearance: none; }
.dl-select:focus, .watch-select:focus { border-color: var(--accent-default); outline: 3px solid var(--accent-default); outline-offset: 2px; }
.confirm-btn { width: 100%; padding: 1.1rem; border-radius: 18px; font-weight: 700; font-size: 1rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.25s; outline: none; letter-spacing: 0.05em; }
.confirm-btn:focus { outline: 4px solid #fff; outline-offset: 3px; }

/* ── VIDEO PANEL ── */
#video-panel { width: 100%; max-width: 960px; display: none; flex-direction: column; gap: 1.25rem; animation: fadeIn 0.3s ease; }
.video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
.video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

/* ── TV NAV HINT ── */
#tv-hint { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; padding: 0.6rem 1.5rem; font-size: 0.78rem; color: #6b7280; display: flex; gap: 1.5rem; z-index: 200; backdrop-filter: blur(10px); pointer-events: none; }
#tv-hint span { display: flex; align-items: center; gap: 0.4rem; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<!-- TV Navigation Hint -->
<div id="tv-hint">
  <span><i class="fas fa-arrows-alt"></i> Navegar</span>
  <span><i class="fas fa-circle"></i> OK / Seleccionar</span>
  <span><i class="fas fa-arrow-left"></i> Volver</span>
</div>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div style="display:flex;align-items:center;padding:0 1.75rem;margin-bottom:2.5rem;gap:1rem;">
    <i class="fas fa-play-circle" style="font-size:1.8rem;color:#e50914;flex-shrink:0;"></i>
    <span class="label" style="font-size:1.3rem;font-weight:700;letter-spacing:-0.03em;">SeriesFav</span>
  </div>
  <nav style="display:flex;flex-direction:column;gap:0.5rem;width:100%;padding:0 0.5rem;">
    <div tabindex="0" onclick="cambiarSeccion('series')" onkeydown="if(event.key==='Enter'||event.key===' ')cambiarSeccion('series')" id="btn-series" class="nav-link active">
      <i class="fas fa-tv"></i>
      <span class="label">Series</span>
    </div>
    <div tabindex="0" onclick="cambiarSeccion('peliculas')" onkeydown="if(event.key==='Enter'||event.key===' ')cambiarSeccion('peliculas')" id="btn-peliculas" class="nav-link">
      <i class="fas fa-film"></i>
      <span class="label">Películas</span>
    </div>
    <div tabindex="0" onclick="cambiarSeccion('favoritos')" onkeydown="if(event.key==='Enter'||event.key===' ')cambiarSeccion('favoritos')" id="btn-favoritos" class="nav-link">
      <i class="fas fa-heart"></i>
      <span class="label">Mi Lista</span>
    </div>
    <div class="filter-group" style="margin-top:2rem;padding:0 0.5rem;display:flex;flex-direction:column;gap:1.5rem;">
      <div>
        <label style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.12em;color:#6b7280;font-weight:700;display:block;margin-bottom:0.5rem;">Estado</label>
        <select id="filtro-seccion" onchange="filtrar()" class="sidebar-select" tabindex="0">
          <option value="">Todo</option>
          <option value="vistas">Vistas</option>
          <option value="no-vistas">Pendientes</option>
          <option value="proximas">Próximamente</option>
        </select>
      </div>
      <div>
        <label style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.12em;color:#6b7280;font-weight:700;display:block;margin-bottom:0.5rem;">Plataforma</label>
        <select id="filtro-plataforma" onchange="filtrar()" class="sidebar-select" tabindex="0">
          <option value="">Todas</option>
          <option value="Netflix">Netflix</option>
          <option value="Disney Plus">Disney Plus</option>
          <option value="Apple TV">Apple TV</option>
          <option value="HBO Max">HBO Max</option>
          <option value="Prime">Prime</option>
          <option value="Otros">Otras</option>
        </select>
      </div>
    </div>
  </nav>
</aside>

<!-- MAIN -->
<main id="main-content">
  <header id="header">
    <div id="promo-container" style="display:none;flex-direction:column;gap:0.6rem;">
      <div id="promo-item" class="promo-widget" tabindex="0"></div>
      <div id="promo-dots" style="display:flex;gap:6px;margin-left:0.5rem;"></div>
    </div>
    <div id="search-bar">
      <i class="fas fa-search" style="color:#6b7280;font-size:0.9rem;"></i>
      <input type="text" id="buscador" placeholder="Buscar contenido..." oninput="filtrar()" class="" autocomplete="off">
    </div>
  </header>
  <div id="content-area">
    <div style="margin-bottom:2rem;">
      <h1 id="main-title" style="font-size:2rem;font-weight:700;letter-spacing:-0.02em;">Catálogo de Series</h1>
      <p id="main-subtitle" style="color:#6b7280;margin-top:0.3rem;font-size:1rem;">Explora tus series favoritas en un solo lugar.</p>
    </div>
    <div id="grid"></div>
  </div>
</main>

<!-- MODAL -->
<div id="modal" onclick="if(event.target===this)cerrarModal()">
  <button id="modal-close" onclick="cerrarModal()" tabindex="0">&times;</button>

  <!-- Info wrapper -->
  <div id="modal-content-wrapper">
    <div id="m-img"></div>
    <div id="m-info-panel">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span id="m-platform" style="font-weight:700;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.12em;"></span>
        <span id="m-release-date" style="display:none;font-size:0.7rem;font-weight:700;padding:0.25rem 0.75rem;border-radius:50px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#e5e7eb;align-items:center;gap:0.5rem;">
          <i class="far fa-calendar-alt" style="color:#e50914;"></i>
          <span id="m-date-text"></span>
        </span>
      </div>
      <h2 id="m-title"></h2>
      <p id="m-desc" tabindex="0"></p>
      <div id="m-season-selector" style="display:none;margin-top:1.5rem;">
        <label style="font-size:0.7rem;text-transform:uppercase;color:#6b7280;font-weight:700;letter-spacing:0.12em;display:block;margin-bottom:0.6rem;">Temporadas</label>
        <div id="m-season-chips"></div>
      </div>
      <div style="margin-top:2rem;display:flex;flex-wrap:wrap;gap:0.6rem;">
        <button id="m-watch-btn" class="modal-action-btn" style="background:#e50914;color:#fff;display:none;" tabindex="0">
          <i class="fas fa-tv"></i> Ver ahora
        </button>
        <button id="m-trailer-btn" class="modal-action-btn" style="background:#fff;color:#000;" tabindex="0">
          <i class="fas fa-play-circle"></i> Tráiler
        </button>
        <button id="m-download-btn" class="modal-action-btn" style="background:#2563eb;color:#fff;display:none;" tabindex="0">
          <i class="fas fa-download"></i> Descargar
        </button>
        <button id="m-fav-toggle" class="modal-action-btn" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:0.65rem 0.9rem;" tabindex="0">
          <i class="fas fa-heart"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Watch selector -->
  <div id="watch-selector" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:1.25rem;">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <div id="watch-type-icon" style="width:2.5rem;height:2.5rem;border-radius:50%;background:rgba(229,9,20,0.1);display:flex;align-items:center;justify-content:center;color:#e50914;">
          <i class="fas fa-tv"></i>
        </div>
        <div>
          <h3 id="watch-modal-title" style="font-size:1.1rem;font-weight:700;line-height:1;">Cargando...</h3>
          <p id="watch-modal-subtitle" style="font-size:0.7rem;color:#6b7280;text-transform:uppercase;margin-top:0.25rem;letter-spacing:0.1em;">Por favor espera</p>
        </div>
      </div>
      <button onclick="cerrarSelectorVer()" tabindex="0" style="color:#6b7280;background:none;border:none;font-size:1.5rem;cursor:pointer;outline:none;padding:0.25rem 0.5rem;border-radius:8px;" onkeydown="if(event.key==='Enter')cerrarSelectorVer()">&times;</button>
    </div>
    <div id="watch-controls"></div>
    <button id="watch-confirm-btn" class="confirm-btn" style="background:#e50914;color:#fff;" tabindex="0">
      <span>REPRODUCIR</span>
      <i class="fas fa-play" style="font-size:0.8rem;opacity:0.7;"></i>
    </button>
  </div>

  <!-- Download selector -->
  <div id="download-selector" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:1.25rem;">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <div style="width:2.5rem;height:2.5rem;border-radius:50%;background:rgba(37,99,235,0.1);display:flex;align-items:center;justify-content:center;color:#3b82f6;">
          <i class="fas fa-cloud-download-alt"></i>
        </div>
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;line-height:1;">Descargar</h3>
          <p style="font-size:0.7rem;color:#6b7280;text-transform:uppercase;margin-top:0.25rem;letter-spacing:0.1em;">Elige tu episodio</p>
        </div>
      </div>
      <button onclick="cerrarSelectorDescarga()" tabindex="0" style="color:#6b7280;background:none;border:none;font-size:1.5rem;cursor:pointer;outline:none;padding:0.25rem 0.5rem;border-radius:8px;">&times;</button>
    </div>
    <div id="dl-controls"></div>
    <button id="dl-confirm-btn" class="confirm-btn" style="background:#2563eb;color:#fff;" tabindex="0">
      <span>IR AL ENLACE</span>
      <i class="fas fa-external-link-alt" style="font-size:0.8rem;opacity:0.7;"></i>
    </button>
  </div>

  <!-- Video panel -->
  <div id="video-panel">
    <div class="video-container">
      <div id="video-loader" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.95rem;background:#000;">Cargando...</div>
      <iframe id="dailymotion-iframe" style="display:none;" src="" frameborder="0" allow="autoplay; fullscreen *; picture-in-picture" allowfullscreen webkitallowfullscreen mozallowfullscreen></iframe>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:0 0.5rem;">
      <h3 id="video-title" style="font-size:1.3rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:1rem;color:#fff;"></h3>
      <button onclick="volverAInfo()" tabindex="0" style="white-space:nowrap;font-size:0.85rem;background:rgba(255,255,255,0.1);color:#fff;padding:0.6rem 1.25rem;border-radius:50px;border:1px solid rgba(255,255,255,0.1);cursor:pointer;outline:none;transition:all 0.2s;" class="modal-action-btn">
        <i class="fas fa-arrow-left" style="margin-right:0.5rem;"></i> Volver a info
      </button>
    </div>
  </div>
</div>

<script>
const URL_JSON = 'https://raw.githubusercontent.com/keiriblest/SeriesFav/main/series-datos%20(1).json';
const plataformaColores = { 'netflix': '#e50914', 'disney plus': '#0063e5', 'apple tv': '#ffffff', 'hbo max': '#5822b4', 'prime': '#00a8e1', 'otros': '#666666', 'peliculas': '#ffcc00' };
const principalesPlataformas = ['netflix', 'disney plus', 'apple tv', 'hbo max', 'prime'];
let catalogo = [], filtrados = [], proximas = [], favoritos = JSON.parse(localStorage.getItem('fav_series')) || [];
let seccionActual = 'series', serieActualIdx = -1, promoIdx = 0;
let esNavegacionProximas = false;
const MAX_DOTS = 5;

// ── SIDEBAR EXPAND on focus within ──
const sidebar = document.getElementById('sidebar');
sidebar.addEventListener('focusin', () => sidebar.classList.add('expanded'));
sidebar.addEventListener('focusout', (e) => {
  if (!sidebar.contains(e.relatedTarget)) sidebar.classList.remove('expanded');
});

async function init() {
  try {
    const res = await fetch(URL_JSON);
    catalogo = await res.json();
    proximas = catalogo.filter(s => s.seccion === 'proximas');
    if (proximas.length > 0) {
      document.getElementById('promo-container').style.display = 'flex';
      createPromoDots();
      startPromoCycle();
    }
    filtrar();
  } catch (e) { console.error("Error cargando el catálogo:", e); }
}

function createPromoDots() {
  const dotsContainer = document.getElementById('promo-dots');
  dotsContainer.innerHTML = "";
  for (let i = 0; i < MAX_DOTS; i++) {
    const dot = document.createElement('div');
    dot.id = `dot-${i}`;
    dot.style.cssText = 'width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.2);transition:all 0.3s;';
    dotsContainer.appendChild(dot);
  }
}

function startPromoCycle() {
  updatePromoUI();
  setInterval(() => { promoIdx = (promoIdx + 1) % proximas.length; updatePromoUI(); }, 6000);
}

function updatePromoUI() {
  const item = proximas[promoIdx];
  if (!item) return;
  const promoEl = document.getElementById('promo-item');
  const color = getColor(item);
  promoEl.innerHTML = `
    <div style="display:flex;width:100%;height:100%;" onclick='abrirModalDesdeMinitarjeta(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
      <img src="${item.imgURL}" style="width:4.5rem;height:100%;object-fit:cover;border-right:1px solid rgba(255,255,255,0.1);">
      <div style="padding:0.75rem;display:flex;flex-direction:column;justify-content:center;flex:1;">
        <span style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:${color};margin-bottom:0.25rem;">Próximamente</span>
        <h5 style="font-size:0.9rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.titulo}</h5>
        <p style="font-size:0.7rem;color:#6b7280;margin-top:0.2rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.plataforma}</p>
      </div>
    </div>`;
  const activeDotIdx = promoIdx % MAX_DOTS;
  for (let i = 0; i < MAX_DOTS; i++) {
    const dot = document.getElementById(`dot-${i}`);
    if (dot) {
      const isActive = i === activeDotIdx;
      dot.style.backgroundColor = isActive ? 'white' : 'rgba(255,255,255,0.2)';
      dot.style.width = isActive ? '14px' : '6px';
    }
  }
}

function esPelicula(item) {
  const tipo = (item.tipo || "").toLowerCase();
  const seccion = (item.seccion || "").toLowerCase();
  const plat = (item.plataforma || "").toLowerCase();
  return tipo === 'pelicula' || tipo === 'peli' || seccion === 'pelis' || plat === 'pelis' || plat === 'película' || plat === 'peliculas';
}

function getColor(item) {
  if (esPelicula(item)) return plataformaColores['peliculas'];
  const p = item.plataforma.toLowerCase();
  return plataformaColores[p] || (principalesPlataformas.includes(p) ? '#e50914' : '#666666');
}

function toggleFavorito(e, titulo) {
  if (e) e.stopPropagation();
  if (favoritos.includes(titulo)) favoritos = favoritos.filter(t => t !== titulo);
  else favoritos.push(titulo);
  localStorage.setItem('fav_series', JSON.stringify(favoritos));
  filtrar();
}

function render(data) {
  const grid = document.getElementById('grid');
  if (data.length === 0) {
    grid.innerHTML = `<div style="grid-column:1/-1;padding:5rem 0;text-align:center;color:#4b5563;">No hay contenido.</div>`;
    return;
  }
  grid.innerHTML = data.map((item, index) => {
    const isFav = favoritos.includes(item.titulo);
    const color = getColor(item);
    return `
      <div class="poster-card" tabindex="0" onclick="abrirModalDesdeCatalogo(${index})" onkeydown="if(event.key==='Enter'||event.key===' ')abrirModalDesdeCatalogo(${index})" role="button" aria-label="${item.titulo}">
        <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorito(event,'${item.titulo.replace(/'/g,"\'")}')" tabindex="-1" aria-label="Favorito">
          <i class="fas fa-heart" ${isFav ? `style="color:${color}"` : ''}></i>
        </button>
        <img src="${item.imgURL}" alt="${item.titulo}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Imagen'" loading="lazy">
        <div class="poster-overlay">
          <span style="font-size:0.65rem;font-weight:900;text-transform:uppercase;letter-spacing:0.1em;color:${color};">${item.plataforma}</span>
          <h4 style="font-size:0.9rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.titulo}</h4>
        </div>
      </div>`;
  }).join('');
}

function filtrar() {
  const query = document.getElementById('buscador').value.toLowerCase();
  const estadoSelect = document.getElementById('filtro-seccion').value;
  const plataformaFiltro = document.getElementById('filtro-plataforma').value;
  const mainTitle = document.getElementById('main-title');
  const mainSubtitle = document.getElementById('main-subtitle');
  if (seccionActual === 'series') { mainTitle.innerText = "Catálogo de Series"; mainSubtitle.innerText = "Explora tus series favoritas."; }
  else if (seccionActual === 'peliculas') { mainTitle.innerText = "Películas"; mainSubtitle.innerText = "El mejor cine a un clic."; }
  else { mainTitle.innerText = "Mi Lista"; mainSubtitle.innerText = "Tu contenido guardado."; }
  filtrados = catalogo.filter(s => {
    const peli = esPelicula(s);
    const matchQuery = s.titulo.toLowerCase().includes(query);
    const tempStr = (s.temporada || "").toUpperCase();
    const numTemp = parseInt(tempStr.replace('T', ''));
    const esTemporadaAlta = tempStr.startsWith('T') && !isNaN(numTemp) && numTemp >= 2;
    const esProximamente = s.seccion === 'proximas';
    if (esTemporadaAlta && !esProximamente) return false;
    let matchSeccion = false;
    if (seccionActual === 'series') matchSeccion = !peli;
    else if (seccionActual === 'peliculas') matchSeccion = peli;
    else if (seccionActual === 'favoritos') matchSeccion = favoritos.includes(s.titulo);
    const matchEstado = !estadoSelect || s.seccion === estadoSelect;
    let matchPlataforma = true;
    if (seccionActual !== 'peliculas') {
      if (plataformaFiltro === 'Todas' || !plataformaFiltro) matchPlataforma = true;
      else if (plataformaFiltro === 'Otros') matchPlataforma = !principalesPlataformas.includes(s.plataforma.toLowerCase());
      else matchPlataforma = s.plataforma.toLowerCase() === plataformaFiltro.toLowerCase();
    }
    return matchQuery && matchSeccion && matchEstado && matchPlataforma;
  });
  render(filtrados);
}

function cambiarSeccion(nuevaSeccion) {
  seccionActual = nuevaSeccion;
  if (nuevaSeccion === 'peliculas') document.getElementById('filtro-plataforma').value = "";
  ['series', 'peliculas', 'favoritos'].forEach(l => {
    const el = document.getElementById(`btn-${l}`);
    if (l === nuevaSeccion) { el.classList.add('active'); el.style.color = 'var(--accent-default)'; }
    else { el.classList.remove('active'); el.style.color = ''; }
  });
  filtrar();
  sidebar.classList.remove('expanded');
  document.getElementById('grid').querySelector('.poster-card')?.focus();
}

function abrirModalDesdeCatalogo(idx) {
  esNavegacionProximas = false;
  abrirModalPorIndice(idx);
}

function abrirModalDesdeMinitarjeta(s) {
  esNavegacionProximas = true;
  const idx = proximas.findIndex(p => p.titulo === s.titulo);
  abrirModalPorIndice(idx);
}

function poblarModal(s) {
  if (!s) return;
  volverAInfo();
  const isFav = favoritos.includes(s.titulo);
  const color = getColor(s);
  const platEl = document.getElementById('m-platform');
  platEl.innerText = s.plataforma || 'Desconocida';
  platEl.style.color = color;
  const dateEl = document.getElementById('m-release-date');
  const dateText = document.getElementById('m-date-text');
  if (s.seccion === 'proximas' && s.fecha && typeof s.fecha === 'string' && s.fecha.trim() !== "") {
    dateText.innerText = `Estreno: ${s.fecha}`;
    dateEl.style.display = 'flex';
  } else {
    dateEl.style.display = 'none';
  }
  document.getElementById('m-title').innerText = s.titulo;
  document.getElementById('m-desc').innerText = s.descripcion || '';
  document.getElementById('m-img').innerHTML = `<img src="${s.imgURL}" style="max-height:90%;max-width:100%;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.8);object-fit:contain;">`;
  const watchBtn = document.getElementById('m-watch-btn');
  const hasVerURL = s.verURL && ((typeof s.verURL === 'string' && s.verURL.trim() !== "") || (Array.isArray(s.verURL) && s.verURL.length > 0));
  if (hasVerURL) { watchBtn.style.display = 'flex'; watchBtn.onclick = () => mostrarSelectorVer(s); }
  else { watchBtn.style.display = 'none'; }
  document.getElementById('m-trailer-btn').onclick = () => reproducirVideo(s.trailerURL, s.titulo, true);
  const seasonSelector = document.getElementById('m-season-selector');
  const seasonChips = document.getElementById('m-season-chips');
  seasonChips.innerHTML = '';
  const versionesMismaSerie = catalogo.filter(item => item.titulo === s.titulo && !esPelicula(item));
  if (versionesMismaSerie.length > 1 && !esPelicula(s)) {
    seasonSelector.style.display = 'block';
    versionesMismaSerie.sort((a, b) => {
      const getNum = (str) => { let label = str.temporada || (str.descargas && str.descargas[0]?.temporada) || "T1"; const num = parseInt(label.toString().replace(/\D/g, '')); return isNaN(num) ? 0 : num; };
      return getNum(a) - getNum(b);
    });
    versionesMismaSerie.forEach(version => {
      let label = version.temporada || (version.descargas && version.descargas[0]?.temporada) || "T1";
      const chip = document.createElement('button');
      const esLaActual = version.imgURL === s.imgURL && version.descripcion === s.descripcion;
      chip.className = 'season-chip';
      chip.style.cssText = esLaActual ? 'background:#fff;color:#000;border:2px solid #fff;' : 'background:rgba(255,255,255,0.06);color:#9ca3af;border:1px solid rgba(255,255,255,0.06);';
      chip.innerText = label.toString().startsWith('T') ? label : `T${label}`;
      chip.tabIndex = 0;
      chip.onclick = () => poblarModal(version);
      chip.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') poblarModal(version); };
      seasonChips.appendChild(chip);
    });
  } else {
    seasonSelector.style.display = 'none';
  }
  const downloadBtn = document.getElementById('m-download-btn');
  if (s.descargas && Array.isArray(s.descargas) && s.descargas.length > 0) {
    downloadBtn.style.display = 'flex';
    downloadBtn.onclick = () => mostrarSelectorDescarga(s);
  } else {
    downloadBtn.style.display = 'none';
  }
  const favBtn = document.getElementById('m-fav-toggle');
  favBtn.style.background = isFav ? color : 'rgba(255,255,255,0.1)';
  favBtn.onclick = () => { toggleFavorito(null, s.titulo); poblarModal(s); };
  document.getElementById('modal').classList.add('flex');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('modal-close').focus(), 50);
}

function mostrarSelectorVer(s) {
  document.getElementById('modal-content-wrapper').style.display = 'none';
  const selector = document.getElementById('watch-selector');
  const controls = document.getElementById('watch-controls');
  const title = document.getElementById('watch-modal-title');
  const subtitle = document.getElementById('watch-modal-subtitle');
  const icon = document.getElementById('watch-type-icon');
  selector.style.display = 'flex';
  const esSerieEpisodica = Array.isArray(s.verURL) && s.verURL.some(item => item.capitulo || item.temporada);
  if (!esSerieEpisodica) {
    title.innerText = "Ver Película"; subtitle.innerText = "Cine en Alta Definición";
    icon.innerHTML = '<i class="fas fa-film"></i>';
    controls.innerHTML = `<div style="padding:1.5rem;background:rgba(229,9,20,0.05);border:1px solid rgba(229,9,20,0.1);border-radius:16px;text-align:center;"><p style="font-weight:700;font-size:0.95rem;color:#d1d5db;">Presiona reproducir para comenzar</p></div>`;
    document.getElementById('watch-confirm-btn').onclick = () => {
      const finalUrl = Array.isArray(s.verURL) ? s.verURL[0] : s.verURL;
      reproducirVideo(finalUrl, s.titulo);
      selector.style.display = 'none';
    };
  } else {
    title.innerText = "Ver Serie"; subtitle.innerText = "Elige el episodio";
    icon.innerHTML = '<i class="fas fa-tv"></i>';
    const itemsVer = s.verURL;
    const temps = [...new Set(itemsVer.map(d => d.temporada))].sort((a, b) => (parseInt(a.toString().replace(/\D/g, '')) || 0) - (parseInt(b.toString().replace(/\D/g, '')) || 0));
    controls.innerHTML = `<div style="display:flex;flex-direction:column;gap:1rem;">
      <div><label style="font-size:0.7rem;text-transform:uppercase;color:#6b7280;font-weight:700;letter-spacing:0.1em;display:block;margin-bottom:0.5rem;">Temporada</label>
      <select id="watch-sel-temp" class="watch-select" tabindex="0">${temps.map(t => `<option value="${t}">${t.toString().startsWith('T') ? 'Temporada ' + t.toString().substring(1) : t}</option>`).join('')}</select></div>
      <div><label style="font-size:0.7rem;text-transform:uppercase;color:#6b7280;font-weight:700;letter-spacing:0.1em;display:block;margin-bottom:0.5rem;">Capítulo</label>
      <select id="watch-sel-cap" class="watch-select" tabindex="0"></select></div></div>`;
    const selTemp = document.getElementById('watch-sel-temp'), selCap = document.getElementById('watch-sel-cap');
    const actualizarCapitulos = () => {
      const caps = itemsVer.filter(d => d.temporada === selTemp.value).sort((a, b) => (parseInt(a.capitulo.toString().replace(/\D/g, '')) || 0) - (parseInt(b.capitulo.toString().replace(/\D/g, '')) || 0));
      selCap.innerHTML = caps.map(c => `<option value="${c.url}">${c.capitulo.toString().startsWith('C') ? 'Capítulo ' + c.capitulo.toString().substring(1) : c.capitulo}</option>`).join('');
    };
    selTemp.onchange = actualizarCapitulos;
    actualizarCapitulos();
    setTimeout(() => selTemp.focus(), 50);
    document.getElementById('watch-confirm-btn').onclick = () => {
      const url = selCap.value;
      const capText = selCap.options[selCap.selectedIndex].text;
      reproducirVideo(url, `${s.titulo} - ${capText}`);
      selector.style.display = 'none';
    };
  }
  setTimeout(() => document.getElementById('watch-confirm-btn').focus(), 80);
}

function cerrarSelectorVer() {
  document.getElementById('watch-selector').style.display = 'none';
  document.getElementById('modal-content-wrapper').style.display = 'grid';
  setTimeout(() => document.getElementById('m-watch-btn').focus(), 50);
}

function mostrarSelectorDescarga(s) {
  document.getElementById('modal-content-wrapper').style.display = 'none';
  const selector = document.getElementById('download-selector');
  const controls = document.getElementById('dl-controls');
  selector.style.display = 'flex';
  const peli = esPelicula(s) || s.descargas.some(d => d.temporada === "Pelis");
  if (peli) {
    controls.innerHTML = `<div style="padding:1.5rem;background:rgba(37,99,235,0.05);border:1px solid rgba(37,99,235,0.1);border-radius:16px;text-align:center;"><p style="font-weight:700;font-size:0.95rem;">Película lista para descarga</p></div>`;
    document.getElementById('dl-confirm-btn').onclick = () => {
      const link = s.descargas[0].url;
      if (link) window.open(link, '_blank');
      cerrarSelectorDescarga();
    };
  } else {
    const temps = [...new Set(s.descargas.map(d => d.temporada))].sort((a, b) => (parseInt(a.toString().replace(/\D/g, '')) || 0) - (parseInt(b.toString().replace(/\D/g, '')) || 0));
    controls.innerHTML = `<div style="display:flex;flex-direction:column;gap:1rem;">
      <select id="sel-temp" class="dl-select" tabindex="0">${temps.map(t => `<option value="${t}">${t.toString().startsWith('T') ? 'Temporada ' + t.toString().substring(1) : t}</option>`).join('')}</select>
      <select id="sel-cap" class="dl-select" tabindex="0"></select></div>`;
    const selTemp = document.getElementById('sel-temp'), selCap = document.getElementById('sel-cap');
    const actualizar = () => {
      const caps = s.descargas.filter(d => d.temporada === selTemp.value).sort((a, b) => (parseInt(a.capitulo.toString().replace(/\D/g, '')) || 0) - (parseInt(b.capitulo.toString().replace(/\D/g, '')) || 0));
      selCap.innerHTML = caps.map(c => `<option value="${c.url}">${c.capitulo.toString().startsWith('C') ? 'Capítulo ' + c.capitulo.toString().substring(1) : c.capitulo}</option>`).join('');
    };
    selTemp.onchange = actualizar; actualizar();
    setTimeout(() => selTemp.focus(), 50);
    document.getElementById('dl-confirm-btn').onclick = () => { if (selCap.value) window.open(selCap.value, '_blank'); cerrarSelectorDescarga(); };
  }
  setTimeout(() => document.getElementById('dl-confirm-btn').focus(), 80);
}

function cerrarSelectorDescarga() {
  document.getElementById('download-selector').style.display = 'none';
  document.getElementById('modal-content-wrapper').style.display = 'grid';
  setTimeout(() => document.getElementById('m-download-btn').focus(), 50);
}

function reproducirVideo(url, titulo, esTrailer = false) {
  document.getElementById('modal-content-wrapper').style.display = 'none';
  const videoPanel = document.getElementById('video-panel');
  const iframe = document.getElementById('dailymotion-iframe');
  const loader = document.getElementById('video-loader');
  videoPanel.style.display = 'flex';
  iframe.style.display = 'none';
  loader.style.display = 'flex';
  loader.innerText = "Cargando...";
  document.getElementById('video-title').innerText = titulo + (esTrailer ? " (Tráiler)" : "");
  if (url && typeof url === 'string' && url.trim() !== "") {
    iframe.src = url;
    iframe.style.display = 'block';
    loader.style.display = 'none';
  } else {
    loader.innerText = "No disponible.";
  }
}

function volverAInfo() {
  document.getElementById('video-panel').style.display = 'none';
  document.getElementById('modal-content-wrapper').style.display = 'grid';
  document.getElementById('dailymotion-iframe').src = "";
}

function abrirModalPorIndice(idx) {
  const lista = esNavegacionProximas ? proximas : filtrados;
  if (!lista || lista.length === 0) return;
  if (idx < 0) idx = lista.length - 1;
  if (idx >= lista.length) idx = 0;
  serieActualIdx = idx;
  poblarModal(lista[idx]);
}

function cerrarModal() {
  document.getElementById('modal').classList.remove('flex');
  document.getElementById('download-selector').style.display = 'none';
  document.getElementById('watch-selector').style.display = 'none';
  document.body.style.overflow = 'auto';
  document.getElementById('dailymotion-iframe').src = "";
  serieActualIdx = -1;
  esNavegacionProximas = false;
}

// ── KEYBOARD NAVIGATION ──
document.addEventListener('keydown', (e) => {
  const modalOpen = document.getElementById('modal').classList.contains('flex');
  if (modalOpen) {
    if (e.key === 'ArrowRight' && serieActualIdx !== -1) { e.preventDefault(); abrirModalPorIndice(serieActualIdx + 1); }
    if (e.key === 'ArrowLeft' && serieActualIdx !== -1) { e.preventDefault(); abrirModalPorIndice(serieActualIdx - 1); }
    if (e.key === 'Escape' || e.key === 'Backspace') { e.preventDefault(); cerrarModal(); }
    return;
  }
  // Grid navigation with arrow keys
  const focused = document.activeElement;
  const cards = [...document.querySelectorAll('.poster-card')];
  const idx = cards.indexOf(focused);
  if (idx === -1) return;
  const cols = Math.round(document.getElementById('grid').offsetWidth / (cards[0]?.offsetWidth || 200));
  if (e.key === 'ArrowRight') { e.preventDefault(); cards[Math.min(idx + 1, cards.length - 1)]?.focus(); }
  if (e.key === 'ArrowLeft') { e.preventDefault(); cards[Math.max(idx - 1, 0)]?.focus(); }
  if (e.key === 'ArrowDown') { e.preventDefault(); cards[Math.min(idx + cols, cards.length - 1)]?.focus(); }
  if (e.key === 'ArrowUp') { e.preventDefault(); cards[Math.max(idx - cols, 0)]?.focus(); }
});

init();
</script>
</body>
</html>